<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AutoMLReportGen — {{ run.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 28px auto;
      max-width: 880px;
      color: #222;
      line-height: 1.45;
      background: #fafafa;
    }
    header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
    h1 { margin: 0; font-size: 1.25rem; }
    h2 { margin-top: 1.4rem; margin-bottom: 0.4rem; font-size: 1.05rem; }
    .muted { color:#6b7280; font-size:0.95rem; }
    .models { display:flex; flex-direction:column; gap:12px; margin-top:8px; }
    .card {
      background:#fff;
      border:1px solid #eee;
      padding:14px;
      border-radius:10px;
      box-shadow: 0 1px 3px rgba(16,24,40,0.04);
    }
    .metrics { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .metric { padding:6px 8px; border-radius:8px; background:#f0f7ff; border:1px solid #e6f0ff; font-size:0.95rem; }
    table { border-collapse:collapse; width:100%; margin-top:8px; }
    th,td { border:1px solid #eee; padding:8px; text-align:left; }
    img.figure { max-width:100%; height:auto; border-radius:6px; border:1px solid #eee; display:block; margin-top:10px; }
    pre { background:#f7f7f7; padding:10px; border-radius:6px; overflow:auto; font-size:0.9rem; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Отчёт: {{ run.name }}</h1>
      <div class="muted">Сформировано: {{ now }}</div>
    </div>
    <div class="muted">Длительность: {{ run.duration_s }} c</div>
  </header>

  <section>
    <h2>Executive summary</h2>
    <div class="card">
      <ul style="margin:0 0 0 18px; padding:0;">
        <li>Моделей: {{ run.meta.models|length if run.meta and run.meta.models else 0 }}</li>
        <li>Артефактов: {{ run.artifacts|length if run.artifacts else 0 }}</li>
        <li>Ключевые метрики показаны в разделе <b>Модели</b></li>
      </ul>
    </div>
  </section>

  <section>
    <h2>Модели</h2>
    {% set models = run.meta.models if run.meta and run.meta.models else {} %}
    {% if models %}
      <div class="models">
        {% for name, info in models.items() %}
          <div class="card">
            <h3>{{ name }} <span class="muted">({{ info.type }})</span></h3>
            <div class="muted">Параметры:</div>
            <pre>{{ info.params }}</pre>

            <div class="muted" style="margin-top:8px">Метрики:</div>
            <div class="metrics">
              {% set mg = run.meta.grouped_metrics[name] if run.meta and run.meta.grouped_metrics and name in run.meta.grouped_metrics else [] %}
              {% if mg %}
                {% for m in mg %}
                  <div class="metric"><b>{{ m.name }}</b><br>{{ "%.4g"|format(m.value) }}</div>
                {% endfor %}
              {% else %}
                <div class="muted">Нет метрик для этой модели</div>
              {% endif %}
            </div>

            <div class="muted" style="margin-top:10px">Графики:</div>
            {% set figs = [] %}
            {% for art in run.artifacts %}
              {% if art.kind == "figure" %}
                {% set _ = figs.append(art) %}
              {% endif %}
            {% endfor %}

            {% if figs %}
              <div class="figures" style="margin-top:8px">
                {% for art in figs %}
                  <img class="figure" src="{{ art.path }}" alt="{{ art.name }}">
                {% endfor %}
              </div>
            {% else %}
              <div class="muted">Нет графиков</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="card muted">Не обнаружено моделей в namespace. Для автоматического обнаружения положите объекты моделей (например sklearn estimators) в переменные, либо явно передайте y_true_* и y_pred_*.</div>
    {% endif %}
  </section>

  <section>
    <h2>Сравнение метрик (все)</h2>
    <div class="card">
      {% if run.metrics %}
        <table>
          <thead><tr><th>Ключ</th><th>Значение</th></tr></thead>
          <tbody>
            {% for k, m in run.metrics.items() %}
              <tr><td>{{ k }}</td><td>{{ m.value }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="muted">Метрики отсутствуют</div>
      {% endif %}
    </div>
  </section>

  <section>
    <h2>Логи и код</h2>
    <div class="card" style="margin-bottom:12px">
      <div class="muted">stdout</div>
      <pre>{{ run.stdout }}</pre>
    </div>
    <div class="card" style="margin-bottom:12px">
      <div class="muted">stderr / error</div>
      {% if run.error %}
        <div style="color:#a00">{{ run.error }}</div>
      {% else %}
        <pre>{{ run.stderr }}</pre>
      {% endif %}
    </div>

    <div class="card">
      <div class="muted">Код (объединённый):</div>
      <pre>{{ run.code }}</pre>
    </div>
  </section>
</body>
</html>
